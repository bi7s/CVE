# CVE-2020-9005

# Description 

Valve Dota 2 (meshsystem.dll) all versions (0-day, no patch) allows remote attackers to achieve code execution or denial of service by creating a gaming server and inviting a victim to this server, because a crafted map is mishandled during a GetValue call.

Attacker need invite a victim to play on attacker game server using specially crafted map or create custom game, then when initialize the game of the victim, the specially crafted map will be automatically downloaded and processed by the victim, which will lead to the possibility to exploit vulnerability. Also attacker can create custom map and upload it to Steam.

## Steps for reproduce:

1) Copy attached file zuff.vpk from archive [zuff.rar](https://github.com/bi7s/CVE/blob/master/CVE-2020-9005/zuff.rar) to map directory (C:\Program Files (x86)\Steam\steamapps\common\dota 2 beta\game\dota\maps)
2) Launch Dota2
3) Attach from windbg to dota2.exe process
3) Launch "zuff" map from Dota2 game console. Command for game console = map zuff
4) Dota2 is crash (Access Violation)

```
(5b8c.1978): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\Program Files (x86)\Steam\steamapps\common\dota 2 beta\game\bin\win64\meshsystem.dll - 
meshsystem!BinaryProperties_GetValue+0x5df1b:
00007ff9`25fbbd2b 392c02          cmp     dword ptr [rdx+rax],ebp ds:0000027a`9fe0f3f9=????????
0:000> r
rax=0000027a9fe0f3f9 rbx=0000000041414141 rcx=0000000000000000
rdx=0000000000000000 rsi=0000000042424242 rdi=0000027a5e9fb2b8
rip=00007ff925fbbd2b rsp=000000a780aff3c0 rbp=0000000041544144
 r8=0000000000000000  r9=0000000000000000 r10=0000027a5e9fb2b0
r11=000000a780aff420 r12=0000027a24d18ae0 r13=0000000000017589
r14=0000027a52956380 r15=00007ff925ffb5a8
iopl=0         nv up ei pl nz na po nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206
meshsystem!BinaryProperties_GetValue+0x5df1b:
00007ff9`25fbbd2b 392c02          cmp     dword ptr [rdx+rax],ebp ds:0000027a`9fe0f3f9=????????
```

[Full debug info](/CVE-2020-9005/windbg.txt)


### Code near exception:

```
00007ff9`25fbbd20 488d041f        lea     rax,[rdi+rbx]
00007ff9`25fbbd24 85db            test    ebx,ebx
00007ff9`25fbbd26 7503            jne     meshsystem!BinaryProperties_GetValue+0x5df1b (00007ff9`25fbbd2b)
00007ff9`25fbbd28 498bc1          mov     rax,r9
00007ff9`25fbbd2b 392c02          cmp     dword ptr [rdx+rax],ebp ds:0000027a`9fe0f3f9=????????
```
### Description:

![](https://github.com/bi7s/CVE/blob/master/CVE-2020-9005/windbg.png)

We have full control for this exception, it can be seen from the code near the exception:

```00007ff925fbbd20 488d041f lea rax,[rdi+rbx] ```

- The register rdi pointing to the area of memory controlled by us! windbg.png, also we have control for rbx, rbx = 0x41414141 That's means that we have control for value for the register rax!

Next

```00007ff925fbbd2b 392c02 cmp dword ptr [rdx+rax],ebp ds:0000027a9fe0f3f9=????????```

- in this instruction rdx = 0 and we have full control for rax thats means that we have control for this exception.

This allows us to intercept the program flow what could lead to remote code execution if attacker will host a malicious server, will be able compromise a remote client by having them download a custom map or addon, triggering remote code execution on the victim's computer. Also we have control the dword of the registers rsi it could help for exploitation this vulnerability.

If extract zuff.vpk then in directory zuff\maps\zuff\worldnodes locate file node000_layer0_b133_mesh_base.vmesh_c. 
Modifying for this file does exception.


![](https://github.com/bi7s/CVE/blob/master/CVE-2020-9005/offset.png)

node000_layer0_b133_mesh_base.vmesh_c - offset for rbx value is 0x8 
node000_layer0_b133_mesh_base.vmesh_c - offset for rsi and values is 0xc

Timeline:

22.07.2019 - Report to hackerone

    - ignore

    - ignore

    - ignore

17.02.2020 - Disclose vulnerability details

### State of report for this vulnerability for hackerone still "triaged"
